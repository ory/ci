version: 2.1
description: Creates and updates the CHANGELOG.md file

orbs:
  changelog:
    executors:
      changelog:
        docker:
          -
            image: circleci/ruby:2.5-node
    jobs:
      changelog:
        parameters:
          gitemail:
            description: The git committer's email
            type: string
            default: aeneas@ory.sh
          gitusername:
            description: The git committer's username
            type: string
            default: aeneasr
          gitauthtoken:
            description: The git committer's username
            type: string
        executor: changelog
        steps:
          - run: git config --global push.default matching
          - checkout
          - run: gem install github_changelog_generator -v 1.14.3
          - run: sudo npm i -g doctoc
          - restore_cache:
              keys:
                - changelog-v1
          - run: github_changelog_generator -u $CIRCLE_PROJECT_USERNAME -p $CIRCLE_PROJECT_REPONAME -o CHANGELOG.md --token <<parameters.gitauthtoken>> --cache-file /tmp/github_changelog_generator
          - save_cache:
              key: changelog-v1
              paths:
                - "/tmp/github_changelog_generator"
          - run: doctoc CHANGELOG.md
          - run: git config --global user.email "<<parameters.gitemail>>"
          - run: git config --global user.name "<<parameters.gitusername>>"
          - run: git add CHANGELOG.md
          - run: |
              git commit -m "Update CHANGELOG [ci skip]" -- CHANGELOG.md
          - run: git push origin

examples:
  changelog:
    description: Generate and commit the changelog
    usage:
      version: 2.1
      orbs:
        foo: ory/changelog@0.0.0
      workflows:
        changelog:
          jobs:
            - changelog/changelog:
                gitauthtoken: $GITHUB_TOKEN
