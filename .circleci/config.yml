version: 2.1
description: Creates and updates the CHANGELOG.md file

orbs:
  orb-tools: circleci/orb-tools@2.0.0
  changelog:
    executors:
      changelog:
        docker:
          -
            image: circleci/ruby:2.5-node
    jobs:
      generate:
        parameters:
          gitemail:
            description: The git committer's email
            type: string
            default: aeneas@ory.sh
          gitusername:
            description: The git committer's username
            type: string
            default: aeneasr
          gitauthtoken:
            description: The git committer's username
            type: string
        executor: changelog
        steps:
          - run: git config --global push.default matching
          - checkout
          - run: gem install github_changelog_generator -v 1.14.3
          - run: sudo npm i -g doctoc
          - restore_cache:
              keys:
                - changelog-v1
          - run: github_changelog_generator -u $CIRCLE_PROJECT_USERNAME -p $CIRCLE_PROJECT_REPONAME -o CHANGELOG.md --token <<parameters.gitauthtoken>> --cache-file /tmp/github_changelog_generator
          - save_cache:
              key: changelog-v1
              paths:
                - "/tmp/github_changelog_generator"
          - run: doctoc CHANGELOG.md
          - run: "sed -i 's/\\*\\*Table of Contents.*/**Table of Contents**/' CHANGELOG.md"
          - run: "sed -i 's/\\*This Change Log was.*/This Change Log was automatically generated/' CHANGELOG.md"
          - run: git config --global user.email "<<parameters.gitemail>>"
          - run: git config --global user.name "<<parameters.gitusername>>"
          - run: git add CHANGELOG.md
          - run: |
              git commit -m "Update CHANGELOG [ci skip]" -- CHANGELOG.md
          - run: git push origin

#orbs:
#  codecov: ory/changelog/@dev:init

workflows:
  changelog:
    jobs:
      - changelog/generate:
          gitauthtoken: $GITHUB_TOKEN
  btd:
    jobs:
      - orb-tools/publish:
          orb-path: src/changelog.yml
          orb-ref: circleci/hello-build@dev:${CIRCLE_BRANCH}
          publish-token-variable: "$CIRCLECI_DEV_API_TOKEN"
          validate: true
